<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Assignment #11 - MPI for Python on Habanero - Research Computing in Earth Sciences</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="./assignment-11-mpi-for-python-on-habanero.html">

        <meta name="author" content="Ryan Abernathey and Kerry Key" />
        <meta name="keywords" content="assignment" />
        <meta name="description" content="Due: Tuesday, 30 November" />

        <meta property="og:site_name" content="Research Computing in Earth Sciences" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Assignment #11 - MPI for Python on Habanero"/>
        <meta property="og:url" content="./assignment-11-mpi-for-python-on-habanero.html"/>
        <meta property="og:description" content="Due: Tuesday, 30 November"/>
        <meta property="article:published_time" content="2017-11-21" />
            <meta property="article:section" content="assignments" />
            <meta property="article:tag" content="assignment" />
            <meta property="article:author" content="Ryan Abernathey and Kerry Key" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.lumen.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/default.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>
        <link href="./static/custom.css" rel="stylesheet">





</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="./" class="navbar-brand">
Research Computing in Earth Sciences            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="./pages/schedule.html">
                             Schedule
                          </a></li>
                         <li><a href="./pages/syllabus.html">
                             Syllabus
                          </a></li>
                        <li class="active">
                            <a href="./category/assignments.html">Assignments</a>
                        </li>
                        <li >
                            <a href="./category/lectures.html">Lectures</a>
                        </li>
                        <li >
                            <a href="./category/software.html">Software</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./assignment-11-mpi-for-python-on-habanero.html"
                       rel="bookmark"
                       title="Permalink to Assignment #11 - MPI for Python on Habanero">
                        Assignment #11 - MPI for Python on Habanero
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-11-21T00:00:00-05:00"> Tue 21 November 2017</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="./tag/assignment.html">assignment</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p><strong>Due: Thursday, 30 November</strong></p>
<p>This purpose of this homework assignment is to get you more familiar with  MPI programming concepts and to run some parallel scaling tests of a code on the Habanero cluster.</p>
<p>Do the following:</p>
<ul>
<li>
<p><strong>Dust of your <em>alternating series</em> function from Assignment #3.</strong> Your function should look something like this. Here we have added an explicit timer function using the <code>timeit</code>  module:
    ~~~python
    from timeit import default_timer as timer</p>
<p>def alternating_harmonic_series(N):
    val = 0.
    for n in range(1, N+1):
        val += (-1)**(n+1) / n
    return val</p>
<p>start = timer()
N     = 100000
value = alternating_harmonic_series(N)
stop  = timer()</p>
<p>print(' Number of terms in series: ',N)
print(' Ending value of series: ',value)
print(' Elapsed time: ',stop-start)</p>
<p>~~~</p>
<p>Test that this serial version of the code works on your laptop. The printed value of the alternating series should be around 0.69314.</p>
</li>
<li>
<p><strong>Create a parallel version of the alternating series code.</strong>
You can start from the serial code above, and just add a few lines of code to make it run in parallel. Here are some tips:</p>
</li>
<li>
<p>Your main code should get the MPI communicator size and rank of each processor using:</p>
<p>~~~python
comm = MPI.COMM_WORLD
rank = comm.Get_rank()
size = comm.Get_size()
~~~</p>
<p>These should be placed after the alternating series function and before <code>start = timer()</code>.</p>
</li>
<li>
<p>Pass in the process <code>rank</code> and <code>size</code> of the communicator to your function:
    ~~~python
    def alternating_harmonic_series(N,rank,size):
        &lt; details of  function code&gt;
    ~~~</p>
</li>
<li>
<p>The function will be called by each parallel process (i.e., each rank). So you you need to modify  <code>range(1,N+1)</code>   to loop over a unique range for each parallel process. In other words, each parallel process will compute part of the sum, and then the results from each parallel process will be later added to give the total sum. See the next bullet point for how to do this.</p>
</li>
<li>
<p>On each process, set the starting value of the sum integer to be  <code>rank</code>+1 and the stride of the loop (aka the increment value) to be the <code>size</code> of the communicator. For example, if we use 4 processors, this means   the rank 0 process will compute the sum over values <strong><em>n = 1, 5, 9, 13...N</em></strong> while the rank 1 process will use  <strong><em>n = 2, 6, 10, 14...N</em></strong>. You  should generalize this using the communicator <code>size</code>.</p>
</li>
<li>
<p>You will use <code>comm.Reduce()</code> to add the partial sums (in <code>values</code>) from each process together on  the root (rank 0) process.  You will have to first convert <code>value</code> to an np.array since <code>comm.Reduce</code> will only work for np.arrays. For example use  <code>send_val = np.array(value,'d')</code>.   Then you will have a command that should be
  <code>comm.Reduce(send_val,sum,op=MPI.SUM,root=0)</code> or similar, where the total sum is now in variable <code>sum</code>.</p>
</li>
<li>
<p>The parallel code should print out the same things as the serial code above. So modify the  code so that the timers and the print statements are only executed on the rank 0 process.  For example:
      ~~~python
      if rank == 0:
        print(' Number of terms in series: ',N)
        ...
      ~~~~</p>
</li>
<li>
<p>Make sure the value of the sum agrees with your serial code when you run the MPI version using one processor.  When running on more processors, there will be small differences due to rounding errors in the reduction operations.</p>
</li>
<li>
<p>If you call your parallel code <code>alternatingSeriesMPI.py</code>, you can run it using the command below (where I'm using the 4 cores on my laptop):
    ~~~python
    $ mpirun -n 4 python alternatingSeriesMPI.py
    ~~~~</p>
</li>
<li>
<p><strong>Run the parallel alternating series code on Habanero.</strong></p>
</li>
<li>
<p>Remember to load the anaconda module after you ssh into Habanero:
    ~~~python
    $ module load anaconda/3-4.4.0
    ~~~~    </p>
</li>
<li>
<p>Set N=100000000 (that's 100,000,000) in the alternating series code.</p>
</li>
<li>
<p>Run it with the number of MPI processes varying from 1,2,3,6,12,24,48,96.  You can run it on 4 Habanero nodes and then specify the various number of processors to use using the <code>-n</code> argument with MPI. Here's what I used for the shell script:
    ~~~bash
    !/bin/sh
    #SBATCH --account=edu    <br>
    #SBATCH --job-name=AlternatingSeries  <br>
    #SBATCH -N 4
    #SBATCH --exclusive
    #SBATCH --time=5:00   </p>
<p>echo "starting alt.sh commands..."</p>
<p>source activate geo_scipy</p>
<p>mpirun -n 1 python alternatingSeriesMPI.py
mpirun -n 2 python alternatingSeriesMPI.py
mpirun -n 3 python alternatingSeriesMPI.py
mpirun -n 6 python alternatingSeriesMPI.py
mpirun -n 12 python alternatingSeriesMPI.py
mpirun -n 24 python alternatingSeriesMPI.py
mpirun -n 48 python alternatingSeriesMPI.py
mpirun -n 96 python alternatingSeriesMPI.py
~~~</p>
<p>Note that you need to use the <code>#SBATCH --exclusive</code> directive above so that you have exclusive access to the <code>-N 4</code> nodes. The  4 compute nodes each have 24 processing cores, so you can run up to 96 MPI processes without oversubscribing the system.</p>
</li>
<li>
<p>Save a table of the timer results for each MPI run that has [number_of_pocesses, time]. I ran the above script several times and noticed up to about 50% variability in the run times when <code>-n 48</code> and <code>-n 96</code> which implies some network latency issues since these larger jobs require two and four nodes communicating over the network. This isn't required, but if you want a more robust scaling test, you should run the script several times and then take the fastest times for each of the <code>-n</code> values used.</p>
</li>
<li>
<p>Use matplotlib to make a plot of the parallel run time scaling. So time on the y axis versus number of processes on the x axis. <strong>Use log scaling for both the x and y axes.</strong> Don't forget to label the axes.  </p>
</li>
<li>
<p><strong>Upload to your github in a new folder called Assignment_11</strong></p>
</li>
<li>your python code</li>
<li>the bash script you used on Habanero</li>
<li>the time scaling plot.</li>
</ul>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">

<!-- Sidebar/Recent Posts -->
<li class="list-group-item">
  <h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Recent Posts</span></h4>
  <ul class="list-group" id="recentposts">
    <li class="list-group-item"><a href="./assignment-11-mpi-for-python-on-habanero.html">Assignment #11 - MPI for Python on Habanero</a></li>
    <li class="list-group-item"><a href="./introduction-to-the-habanero-hpc-cluster.html">Introduction to the Habanero HPC Cluster</a></li>
    <li class="list-group-item"><a href="./parallel-programming-with-mpi-for-python.html">Parallel Programming with MPI For Python</a></li>
    <li class="list-group-item"><a href="./assignment-10-packaging-python-code.html">Assignment #10 - Packaging Python Code</a></li>
    <li class="list-group-item"><a href="./organization-and-packaging-of-python-projects.html">Organization and Packaging of Python Projects</a></li>
    <li class="list-group-item"><a href="./assignment-9-map-making-and-geomapapp.html">Assignment #9 -  Map Making and GeoMapApp</a></li>
    <li class="list-group-item"><a href="./intro-to-basemap.html">Map making in Python with Basemap</a></li>
    <li class="list-group-item"><a href="./final-project-instructions.html">Final Project Instructions</a></li>
    <li class="list-group-item"><a href="./introduction-to-generic-mapping-tools-gmt.html">Introduction to Generic Mapping Tools (GMT)</a></li>
    <li class="list-group-item"><a href="./assignment-8-xarray.html">Assignment 8 - Xarray</a></li>
  </ul>
</li>
<!-- End Sidebar/Recent Posts -->

<!-- Sidebar/Tag Cloud -->
<li class="list-group-item">
  <a href="./"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
  <ul class="list-group " id="tags">
    <li class="list-group-item tag-1">
      <a href="./tag/assignment.html">assignment</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/shell.html">shell</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/python.html">python</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/programming.html">programming</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/file-system.html">file system</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/bash.html">bash</a>
    </li>
    <li class="list-group-item tag-1">
      <a href="./tag/unix.html">unix</a>
    </li>
    <li class="list-group-item tag-2">
      <a href="./tag/pandas.html">pandas</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/gmt.html">GMT</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/visualization.html">visualization</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/matlab.html">MATLAB</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/fortran.html">fortran</a>
    </li>
    <li class="list-group-item tag-3">
      <a href="./tag/git.html">git</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/final.html">final</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/source-code-editor.html">source code editor</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/parallel-computing.html">parallel computing</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/ndarray.html">ndarray</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/mapping.html">mapping</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/parallel-programming.html">parallel programming</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/xarray.html">xarray</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/arrays.html">arrays</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/github.html">github</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/packaging.html">packaging</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/version-control.html">version control</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/basemap.html">basemap</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/cluster.html">cluster</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/project.html">project</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/numpy.html">numpy</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/geomapapp.html">GeoMapApp</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/matplotlib.html">matplotlib</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/habanero.html">habanero</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/mpi.html">mpi</a>
    </li>
    <li class="list-group-item tag-4">
      <a href="./tag/vpn.html">vpn</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Tag Cloud -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2017 Ryan Abernathey and Kerry Key
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-nc/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/deed.en">Creative Commons Attribution-NonCommercial 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>

    <script src="./theme/js/bodypadding.js"></script>


</body>
</html>